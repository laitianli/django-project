{% load static %}
{% load i18n %}
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟机管理系统注册</title>
    <link rel="stylesheet" href="{% static './bootstrap-5.3.0-alpha1/dist/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static './css/all.min.css' %}">
    <script src="{% static './js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static './bootstrap-5.3.0-alpha1/dist/js/bootstrap.bundle.min.js' %}"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: "Microsoft YaHei", sans-serif;
            position: relative;
            overflow: hidden;
            padding: 20px;
        }

        /* 云朵背景 */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23ffffff' fill-opacity='0.2' d='M0,224L48,213.3C96,203,192,181,288,160C384,139,480,117,576,122.7C672,128,768,160,864,170.7C960,181,1056,171,1152,165.3C1248,160,1344,160,1392,160L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            z-index: -1;
        }

        .container-wrapper {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            font-weight: bold;
            font-size: 24px;
            padding-top: 15px;
        }

        .login-container {
            background: white;
            padding: 30px;
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        .welcome-header h2 {
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .new-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff5252;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .nav-tabs {
            border: none;
            margin-bottom: 20px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #666;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 4px 4px 0 0;
        }

        .nav-tabs .nav-link.active {
            color: #1976d2;
            background: transparent;
            border-bottom: 2px solid #1976d2;
        }

        .form-label {
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }

        .form-control {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .input-group-text {
            background: #f5f5f5;
            color: #666;
        }

        .verification-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .verification-section .form-control {
            flex: 1;
            margin-bottom: 0;
        }

        .verification-img {
            background: #f0f0f0;
            border: 1px solid #ced4da;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
            height: 45px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            user-select: none;
        }

        .btn-sms {
            white-space: nowrap;
            background: #f5f5f5;
            color: #1976d2;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px 15px;
            height: 45px;
        }

        .btn-sms:hover {
            background: #e9e9e9;
        }

        .form-check {
            margin: 20px 0;
        }

        .form-check-label {
            color: #666;
            font-size: 14px;
        }

        .form-check-input {
            margin-top: 0.2rem;
        }

        .btn-register {
            background: #1976d2;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-weight: 500;
            width: 100%;
            border: none;
            transition: background 0.3s;
        }

        .btn-register:hover {
            background: #1565c0;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-bottom: 15px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 14px;
        }

        .footer-links a:hover {
            color: white;
            text-decoration: underline;
        }

        /* 响应式调整 */
        @media (max-height: 700px) {
            .container-wrapper {
                max-height: 85vh;
            }

            .login-container {
                padding: 20px;
            }
        }

        @media (max-width: 576px) {
            .verification-section {
                flex-direction: column;
            }

            .verification-img,
            .btn-sms {
                width: 100%;
                margin-top: 5px;
            }

            body {
                padding: 10px;
            }
        }

        /* 自定义滚动条 */
        .container-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        .container-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 0 8px 8px 0;
        }

        .container-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 8px;
        }

        .container-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .form-control::placeholder {
            opacity: 0.5;
            /* 设置透明度为50% */
            color: #999;
            /* 可选：同时改变文字颜色 */
        }

        /* 错误提示样式 */
        .error-message {
            color: #ff5252;
            font-size: 12px;
            margin-top: -10px;
            margin-bottom: 10px;
            display: none;
        }

        /* 加载动画 */
        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
        }

        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
    </style>
</head>

<body>
    <div class="container-wrapper">
        <div class="logo">
            <span>VMWManager</span> <span style="color: #ff5252;">虚拟机管理系统</span>
        </div>

        <div class="login-container">
            <div class="welcome-header">
                <h2>欢迎注册虚拟机管理系统</h2>
                <span class="new-badge">NEW</span>
            </div>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="email-tab" data-bs-toggle="tab" data-bs-target="#email"
                        type="button" role="tab" aria-controls="email" aria-selected="true">邮箱注册用户</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="mobile-tab" data-bs-toggle="tab" data-bs-target="#mobile" type="button"
                        role="tab" aria-controls="mobile" aria-selected="false">手机注册用户</button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="email" role="tabpanel" aria-labelledby="email-tab">
                    <form id="registerForm" method="post">
                        <div class="mb-3">
                            <label class="form-label">用户名：</label>
                            <input type="text" class="form-control" id="username" name="username"
                                placeholder="请输入用户名">
                            <div class="error-message" id="usernameError"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">邮箱地址：</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="emailPrefix" name="emailPrefix"
                                    placeholder="请输入邮箱前缀">
                                <select name="emailType" id="emailType" class="form-control form-select">
                                    <option value="@sina.com">@sina.com</option>
                                    <option value="@163.com">@163.com</option>
                                    <option value="@outlook.com" selected>@outlook.com</option>
                                    <option value="@gmail.com">@gmail.com</option>
                                </select>
                            </div>
                            <div class="error-message" id="emailError"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">密码：</label>
                            <input type="password" class="form-control" id="password" name="password"
                                placeholder="请输入密码">
                            <div class="error-message" id="passwordError"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">确认密码：</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                placeholder="请再次输入密码">
                            <div class="error-message" id="confirmPasswordError"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">手机号码：</label>
                            <input type="tel" class="form-control" id="phone" name="phone" placeholder="请输入手机号码">
                            <div class="error-message" id="phoneError"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">用户类别：</label>
                            <select name="userType" id="userType" class="form-control form-select">
                                <option value="normaluser" selected>普通用户 - 可以创建虚拟机</option>
                                <option value="susperuser">超级用户 - 可以登录后台</option>
                                <option value="vmuser">虚拟机用户 - 只能使用分配的虚拟机</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">图片验证码：</label>
                            <div class="verification-section">
                                <input type="text" class="form-control" id="captcha" name="captcha"
                                    placeholder="请输入验证码">
                                <div class="verification-img" id="captchaImage">K908</div>
                            </div>
                            <div class="error-message" id="captchaError"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">短信验证码：</label>
                            <div class="verification-section">
                                <input type="text" class="form-control" id="smsCode" name="smsCode"
                                    placeholder="请输入短信验证码">
                                <button type="button" class="btn-sms" id="getSmsBtn">免费获取短信验证码</button>
                            </div>
                            <div class="error-message" id="smsCodeError"></div>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agreeCheck" name="agreeCheck">
                            <label class="form-check-label" for="agreeCheck">
                                我已经阅读并接受《网络服务使用协议》、《邮箱隐私政策》和《邮箱服务条款》
                            </label>
                        </div>
                        <div class="error-message" id="agreeError"></div>

                        <button type="submit" class="btn btn-register" id="registerBtn">立即注册</button>

                        <div class="loading" id="loadingIndicator">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在提交注册信息，请稍候...</p>
                        </div>
                    </form>
                </div>

                <div class="tab-pane fade" id="mobile" role="tabpanel" aria-labelledby="mobile-tab">
                    <div class="alert alert-info">
                        手机注册用户名功能正在维护中，请使用邮箱注册用户名。
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-links">
            <a href="#">免费虚拟机</a>
            <!-- <a href="#">VIP虚拟机</a> -->
            <a href="#">高性能虚拟机</a>
        </div>
    </div>



    <script>
        $(document).ready(function () {
            // 刷新验证码
            function refreshCaptcha() {
                var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                var captcha = "";
                for (var i = 0; i < 4; i++) {
                    captcha += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                $("#captchaImage").text(captcha);
            }

            // 初始化验证码
            refreshCaptcha();

            // 点击验证码刷新
            $("#captchaImage").click(function () {
                refreshCaptcha();
            });

            // 获取短信验证码按钮
            $("#getSmsBtn").click(function () {
                var btn = $(this);
                var countdown = 60;

                btn.prop("disabled", true);
                btn.text(countdown + "秒后重新获取");

                var timer = setInterval(function () {
                    countdown--;
                    if (countdown > 0) {
                        btn.text(countdown + "秒后重新获取");
                    } else {
                        clearInterval(timer);
                        btn.prop("disabled", false);
                        btn.text("免费获取短信验证码");
                    }
                }, 1000);
            });

            // 表单验证
            function validateForm() {
                var isValid = true;

                // 重置错误信息
                $(".error-message").hide();

                // 验证密码
                var username = $("#username").val();
                if (!username) {
                    $("#usernameError").text("请输入用户名").show();
                    isValid = false;
                } else if (username.length < 6) {
                    $("#usernameError").text("用户名长度不能少于6位").show();
                    isValid = false;
                }

                // 验证邮箱前缀
                var emailPrefix = $("#emailPrefix").val();
                if (!emailPrefix) {
                    $("#emailError").text("请输入邮箱前缀").show();
                    isValid = false;
                } else if (!/^[a-zA-Z0-9_]{3,20}$/.test(emailPrefix)) {
                    $("#emailError").text("邮箱前缀必须是3-20位的字母、数字或下划线").show();
                    isValid = false;
                }

                // 验证密码
                var password = $("#password").val();
                if (!password) {
                    $("#passwordError").text("请输入密码").show();
                    isValid = false;
                } else if (password.length < 6) {
                    $("#passwordError").text("密码长度不能少于6位").show();
                    isValid = false;
                }

                // 验证确认密码
                var confirmPassword = $("#confirmPassword").val();
                if (password !== confirmPassword) {
                    $("#confirmPasswordError").text("两次输入的密码不一致").show();
                    isValid = false;
                }

                // 验证手机号码
                var phone = $("#phone").val();
                if (!phone) {
                    $("#phoneError").text("请输入手机号码").show();
                    isValid = false;
                } else if (!/^1[3-9]\d{9}$/.test(phone)) {
                    $("#phoneError").text("请输入正确的手机号码格式").show();
                    isValid = false;
                }

                // 验证图片验证码
                var captcha = $("#captcha").val();
                if (!captcha) {
                    $("#captchaError").text("请输入图片验证码").show();
                    isValid = false;
                }

                // 验证短信验证码
                var smsCode = $("#smsCode").val();
                if (!smsCode) {
                    $("#smsCodeError").text("请输入短信验证码").show();
                    isValid = false;
                }

                // 验证协议勾选
                if (!$("#agreeCheck").prop("checked")) {
                    $("#agreeError").text("请阅读并同意相关协议").show();
                    isValid = false;
                }

                return isValid;
            }

            // 表单提交
            $("#registerForm").submit(function (e) {
                e.preventDefault();

                if (!validateForm()) {
                    return;
                }

                // 显示加载指示器
                $("#loadingIndicator").show();
                $("#registerBtn").prop("disabled", true);

                // 收集表单数据
                var formData = {
                    username: $('#username').val(),
                    email: $("#emailPrefix").val() + $("#emailType").val(),
                    password: $("#password").val(),
                    phone: $("#phone").val(),
                    usertype: $('#userType').val(),
                    captcha: $("#captcha").val(),
                    smsCode: $("#smsCode").val(),
                    agree: $("#agreeCheck").prop("checked")
                };

                Object.keys(formData).forEach(key => {
                    console.log(`${key}` + ": " + `${formData[key]}`)
                });
                // host = '{{ host_with_port }}'
                // console.log(host)
                console.log(JSON.stringify(formData))
                // 使用AJAX发送POST请求http://{{ host_with_port }}
                $.ajax({
                    url: "/accounts/register/", // 替换为实际的API地址
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    dataType: "json",
                    success: function (response) {
                        // 隐藏加载指示器
                        $("#loadingIndicator").hide();
                        $("#registerBtn").prop("disabled", false);

                        if (response.success) {
                            // 注册成功
                            window.location.href = '/index';
                        } else {
                            // 注册失败，显示错误信息
                            alert("注册失败: " + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        // 隐藏加载指示器
                        $("#loadingIndicator").hide();
                        $("#registerBtn").prop("disabled", false);

                        // 处理错误
                        alert("请求失败，请稍后重试。错误信息: " + error);
                    }
                });
                // alert("注册请求已提交！");
            });
        });
    </script>
</body>

</html>